# ============================================================
# DFEM + PINN 总配置
# - 本版：三种材料 jingmian / structural_steel / zhijia
# - 弹性主模型：线弹性 + 预紧 + 接触/摩擦
# - 额外保存了屈服强度、密度、热导率等，便于后处理
# ============================================================

# ------------------------------------------------------------
# 1. 材料库
# ------------------------------------------------------------

# 材料标签的枚举（顺序无所谓，但名字要和下面 material_properties 一致）
material_enum:
  - jingmian
  - structural_steel
  - zhijia

# 各材料的属性。当前 DFEM 静力分析只会用到 E 和 nu，
# 其它参数为后续屈服判定、动力学、热–结构耦合等做准备。
material_properties:
  jingmian:
    # ---- 基本弹性参数（当前 DFEM 会用到）----
    E: 6.9e4            # MPa，杨氏模量
    nu: 0.33            # 泊松比

    # 冗余弹性量（由 E, nu 推导，保留便于校验/扩展）
    bulk_modulus: 6.7647e4    # MPa，体积模量 K
    shear_modulus: 2.594e4    # MPa，剪切模量 G

    # 密度与热学参数（后续若做动力学/热应力可用）
    density: 2700.0           # kg/m^3
    alpha_thermal: 2.4e-5     # 1/K，各向同性线膨胀系数
    k_thermal: 166.9          # W/(m·K)，各向同性热导率
    cp: 896.0                 # J/(kg·K)，比热容

    # 强度参数（屈服/极限），可用于后处理安全系数或损伤指标
    sigma_y_tension: 2.8e2        # MPa，拉伸屈服强度
    sigma_y_compression: 2.8e2    # MPa，压缩屈服强度
    sigma_u_tension: 3.1e2        # MPa，拉伸极限强度

    # 如需疲劳分析，可在此增加 S–N 曲线数据
    # sn_curve:
    #   R: -1
    #   points:
    #     - [1.7e3, 2.75e8]
    #     - [5.0e3, ...]
    #     ...

  structural_steel:
    # ---- 基本弹性参数 ----
    E: 2.0e5           # MPa，杨氏模量
    nu: 0.30           # 泊松比

    # 冗余弹性量
    bulk_modulus: 1.6667e5    # MPa，体积模量 K
    shear_modulus: 7.6923e4   # MPa，剪切模量 G

    # 密度与热学参数
    density: 7850.0           # kg/m^3
    alpha_thermal: 1.2e-5     # 1/K
    k_thermal: 60.5           # W/(m·K)
    cp: 434.0                 # J/(kg·K)

    # 强度参数
    sigma_y_tension: 2.5e2        # MPa
    sigma_y_compression: 2.5e2    # MPa
    sigma_u_tension: 4.6e2        # MPa

  zhijia:
    # ---- 基本弹性参数 ----
    E: 7.42e4          # MPa，杨氏模量
    nu: 0.36           # 泊松比

    # 冗余弹性量
    bulk_modulus: 8.8333e4    # MPa，体积模量 K
    shear_modulus: 2.7279e4   # MPa，剪切模量 G

    # 密度与热学参数
    density: 2850.0           # kg/m^3
    alpha_thermal: 2.38e-5    # 1/K
    k_thermal: 44.0           # W/(m·K)
    cp: 460.0                 # J/(kg·K)

    # 强度参数
    sigma_y_tension: 2.8e2        # MPa
    sigma_y_compression: 2.8e2    # MPa
    sigma_u_tension: 3.1e2        # MPa

# ------------------------------------------------------------
# 2. Part → 材料映射（需与 INP 中 Part 名一致）
# ------------------------------------------------------------
part2mat:
  mirror1: jingmian
  mirror2: jingmian

  bolt1:   structural_steel
  bolt2:   structural_steel
  bolt3:   structural_steel

  auto:    zhijia      # 支架/中间件使用 zhijia 材料

# ------------------------------------------------------------
# 3. 预紧螺栓与装配面
# ------------------------------------------------------------
bolts:
  - name: bolt1
    up_surface_key:   'ASM::"bolt1 up"'
    down_surface_key: 'ASM::"bolt1 down"'
  - name: bolt2
    up_surface_key:   'ASM::"bolt2 uo"'      # 注意：INP 中名为 "uo"
    down_surface_key: 'ASM::"bolt2 down"'
  - name: bolt3
    up_surface_key:   'ASM::"bolt3 up"'
    down_surface_key: 'ASM::"bolt3 down"'

# 预紧分阶段/顺序设置（enabled=true 则训练/推理都会按照顺序分步加载）
preload_staging:
  enabled: true              # 启用分阶段加载 -> PINN 输入包含顺序信息
  randomize_order: true      # 训练时随机打乱三颗螺栓的加载顺序
  repeat: 3                  # 每组顺序持续的步数（>1 时可重复使用同一组合）
  shuffle: false             # 若提供 sequence 列表，是否在 epoch 间随机打乱条目
  jitter: 0.0                # 顺序列表在训练时叠加的 ±jitter 噪声（N）
  relaxation: 0.25           # 顺序松弛系数；>0 时早拧的螺栓载荷放大、晚拧的减小
  # sequence:               # 如需固定顺序，可取消注释并填写：
  #   - values: [800, 600, 500]
  #     order:  [1, 3, 2]    # 顺序字段支持 1-based 或 0-based

# ------------------------------------------------------------
# 4. 接触对设置（master/slave surface 名需与 INP 中一致）
# ------------------------------------------------------------
contact_pairs:
  # INP 中定义的 13 组接触对（主/从表面名需与 INP 完全一致）
  - master_key: 'ASM::"mirror1 auto"'
    slave_key:  'ASM::"auto mirror1"'
    interaction: 'fri'
  - master_key: 'ASM::"bolt1 auto down"'
    slave_key:  'ASM::"bolt1 down"'
    interaction: 'fri'
  - master_key: 'ASM::"bolt3 mirror up"'
    slave_key:  'ASM::"bolt1 up"'
    interaction: 'fri'
  - master_key: 'ASM::"bolt1 auto s"'
    slave_key:  'ASM::"bolt1 s"'
    interaction: 'fri'
  - master_key: 'ASM::"bolt1 mirror s"'
    slave_key:  'ASM::"bolt1 s"'
    interaction: 'fri'
  - master_key: 'ASM::"bolt2 auto down"'
    slave_key:  'ASM::"bolt2 down"'
    interaction: 'fri'
  - master_key: 'ASM::"bolt3 mirror up"'
    slave_key:  'ASM::"bolt2 uo"'
    interaction: 'fri'
  - master_key: 'ASM::"bolt2 auto s"'
    slave_key:  'ASM::"bolt2 s"'
    interaction: 'fri'
  - master_key: 'ASM::"bolt2 mirror s"'
    slave_key:  'ASM::"bolt2 s"'
    interaction: 'fri'
  - master_key: 'ASM::"bolt3 auto down"'
    slave_key:  'ASM::"bolt3 down"'
    interaction: 'fri'
  - master_key: 'ASM::"bolt3 mirror up"'
    slave_key:  'ASM::"bolt3 up"'
    interaction: 'fri'
  - master_key: 'ASM::"bolt3 auto s"'
    slave_key:  'ASM::"bolt3 s"'
    interaction: 'fri'
  - master_key: 'ASM::"bolt3 mirror s"'
    slave_key:  'ASM::"bolt3 s"'
    interaction: 'fri'

# ------------------------------------------------------------
# 4.5 边界条件（固定约束）
# ------------------------------------------------------------
# 默认使用 ALM 模式，以较低罚系数逼近硬约束；如需退回纯罚函数，可改为 penalty。
bc_mode: alm            # alm | penalty | hard
bc_alpha: 1.0e4         # 罚函数/ALM 基础刚度
bc_mu: 1.0e3            # ALM 增广系数

# ------------------------------------------------------------
# 5. 网络与优化器配置（后续 DFEM 改造时会用）
# ------------------------------------------------------------
network_config:
  model_type: pinn         # 之后会 DFEM 化：网络预测节点位移/场
  input_dim: 3             # 例如三个预紧力或加载参数
  output_dim: 1            # 目标量维度；如需输出完整位移场可在代码中扩展
  layers:
    - 64
    - 64
    - 32

# ------------------------------------------------------------
# 6. 后处理与可视化
# ------------------------------------------------------------
# 指定镜面表面名，用于镜面变形可视化与相关后处理；需与 INP 表面名完全匹配。
mirror_surface_name: 'MIRROR up'

optimizer_config:
  type: Adam
  learning_rate: 0.0005
  grad_clip_norm: 1.0e6
  batch_size: 32
  epochs: 1000              # Adam 阶段的迭代步数
  lbfgs:
    enabled: false           # 是否在 Adam 之后追加 L-BFGS 精调
    max_iter: 200           # L-BFGS 最大迭代次数
    tolerance: 1.0e-6       # 收敛判据（目标函数相对变化）
    history_size: 50        # 拟牛顿历史记忆对数
    line_search: 50         # 线搜索最大迭代
    reuse_last_batch: true  # true 表示复用 Adam 最后一次随机样本

# ------------------------------------------------------------
# 6. 弹性 DFEM 配置（ElasticityConfig）
# ------------------------------------------------------------
elasticity_config:
  coord_scale: 1.0          # 坐标缩放系数
  chunk_size: 0             # 节点前向微批大小；≤0 表示整图前向，不再分块
  use_pfor: false           # 保留字段，可忽略
  check_nan: true           # 是否进行数值 NaN 检查
  n_points_per_step: 4096   # 每步用于 DFEM 积分的子单元/积分点上限；None 表示全量

# ------------------------------------------------------------
# 7. 损失函数与自适应加权（TotalConfig + weighted PINN）
# ------------------------------------------------------------
loss_config:
  base_weights:
    w_int: 1.0e-7      # 内能
    w_cn: 1.0e-7      # 法向接触能量
    w_ct: 1.0e-7      # 摩擦能量/摩擦残差
    w_tie: 1.0e-7     # 绑定/多体约束
    w_bc: 1.0e4       # 边界条件强罚函数（近似硬约束）
    w_pre: 1.0e-7     # 预紧功（乘在 -W_pre 上）
    w_sigma: 1.0e-7   # 应力监督

  adaptive:
    enabled: true           # 是否启用自适应加权（weighted PINN）
    update_every: 10        # 每多少个 global step 更新一次权重
    ema_decay: 0.99         # 残差/能量的 EMA 衰减系数
    temperature: 1.0        # softmax 温度
    min_weight: 1.0e-9      # 单项权重下限
    max_weight: 1.0e2       # 单项权重上限
    focus_terms:
      - w_int
      - w_cn
      - w_ct
      - w_pre   # 重点自适应的损失项

# ------------------------------------------------------------
# 8. 输出与可视化
# ------------------------------------------------------------
output_config:
  save_path: './results'
  visualize: true
  viz_use_shape_function_interp: true   # 启用形函数插值，让镜面云图更光滑
  viz_surface_source: "surface"         # 使用 INP 提供的单层镜面
  viz_refine_subdivisions: 2            # 细分 2 层已足够，后续由 griddata 提升分辨率

# ------------------------------------------------------------
# 9. INP 文件路径
# ------------------------------------------------------------
inp_path: D:/shuangfan/shuangfan.inp

# ------------------------------------------------------------
# 10. 训练采样/调度（main.py 会读取这些值覆盖默认兜底）
# ------------------------------------------------------------
n_contact_points_per_pair: 2400     # 每对接触面的采样数（单阶段）
preload_n_points_each: 800         # 单个螺栓端面的采样数
resample_contact_every: 5          # 每隔多少步重采样接触点（0=只采样首步）
alm_update_every: 75               # 接触 ALM 罚乘子更新周期


n_tie_points: 2000
tie_alpha: 1e3
bc_alpha: 1e4
